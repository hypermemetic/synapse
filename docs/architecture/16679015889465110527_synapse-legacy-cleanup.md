# Synapse Legacy Code Cleanup Plan

## Overview

With the IR-driven approach now complete for Help, Parse, and Template generation, several legacy code paths exist that can be removed. This document inventories legacy code and provides a cleanup plan.

## Architecture: Old vs New

```
OLD (Schema-based):                    NEW (IR-based):

PluginSchema                           PluginSchema
    │                                      │
    ▼                                      ▼
SchemaF (functor)                      IR.Builder.buildIR
    │                                      │
    ▼                                      ▼
Algebra.Walk                           IR (MethodDef, TypeDef, etc.)
    │                                      │
    ├─► Algebra.TemplateGen                ├─► CLI.Template
    │   (JSON Schema → Mustache)           │   (IR → Mustache)
    │                                      │
    └─► Direct schema inspection           ├─► CLI.Help
                                           │   (IR → help text)
                                           │
                                           └─► CLI.Parse
                                               (IR → arg parsing)
```

## Legacy Code Inventory

### HIGH PRIORITY - Remove Now

#### 1. Algebra.TemplateGen Module
- **File**: `src/Synapse/Algebra/TemplateGen.hs`
- **Lines**: ~328
- **Purpose**: JSON Schema → Mustache templates via SchemaF catamorphism
- **Replaced by**: `CLI.Template.hs` (IR-driven)
- **Status**: REMOVE

#### 2. Old Template Generation Flag in Main.hs
- **Location**: `app/Main.hs`
- **Items to remove**:
  ```haskell
  -- Line 21: import
  import Synapse.Algebra.TemplateGen (GeneratedTemplate(..), generateAllTemplatesWithCallback)

  -- Line 55: Args field
  , argGenerate  :: Bool  -- ^ Generate templates from schemas (legacy)

  -- Lines 113-123: dispatch branch
  else if argGenerate then do ...

  -- Lines 374-381: helper function
  writeGeneratedTemplate :: FilePath -> GeneratedTemplate -> IO ()

  -- Lines 502-504: parser
  argGenerate <- switch ( long "generate-templates" <> short 'g' ... )
  ```

#### 3. Algebra.Complete Module
- **File**: `src/Synapse/Algebra/Complete.hs`
- **Lines**: ~25
- **Purpose**: Shell completions from schema
- **Status**: REMOVE (unused, no imports found)

### MEDIUM PRIORITY - Deprecate

#### 4. Schema.Functor Dependencies
- **File**: `src/Synapse/Schema/Functor.hs`
- **Used by**: Walk.hs, Recursion.hs, (formerly TemplateGen.hs)
- **Status**: Keep for now (still used by navigation)
- **Future**: Refactor navigation to IR, then remove

### LOW PRIORITY - Keep with Notes

#### 5. Algebra.Navigate
- **File**: `src/Synapse/Algebra/Navigate.hs`
- **Status**: KEEP - core to CLI path resolution
- **Note**: Works at schema level before IR is built

#### 6. parseContentType in Renderer
- **File**: `src/Synapse/Renderer.hs`
- **Status**: KEEP - fallback when method path hint not available

## File Impact Summary

| File | Action | Lines Affected |
|------|--------|----------------|
| `src/Synapse/Algebra/TemplateGen.hs` | DELETE | 328 |
| `src/Synapse/Algebra/Complete.hs` | DELETE | 25 |
| `app/Main.hs` | EDIT | -50 |
| `synapse-cli.cabal` | EDIT | -2 (exposed modules) |

**Total lines removed**: ~400

## Module Dependency Graph (Post-Cleanup)

```
Main.hs
├── Synapse.Monad
├── Synapse.Transport
├── Synapse.Renderer
├── Synapse.Schema.Types
├── Synapse.Algebra.Navigate  (keep - path resolution)
├── Synapse.Algebra.Walk      (keep - schema traversal)
├── Synapse.IR.Builder        (NEW - builds IR)
├── Synapse.CLI.Template      (NEW - IR templates)
├── Synapse.CLI.Help          (NEW - IR help)
├── Synapse.CLI.Parse         (NEW - IR parsing)
└── Synapse.CLI.Support       (NEW - IR support detection)
```

## Cleanup Steps

### Step 1: Remove Legacy Template Generation
```bash
# Remove module
rm src/Synapse/Algebra/TemplateGen.hs

# Remove from cabal
# Edit synapse-cli.cabal, remove: Synapse.Algebra.TemplateGen

# Edit Main.hs - remove import, flag, handler, helper
```

### Step 2: Remove Unused Complete Module
```bash
rm src/Synapse/Algebra/Complete.hs
# Edit synapse-cli.cabal, remove: Synapse.Algebra.Complete
```

### Step 3: Rename Flag
```haskell
-- In Main.hs, rename:
argGenerateIR -> argGenerate
--generate-templates-ir -> --generate-templates
```

### Step 4: Verify
```bash
cabal build
cabal test
synapse plexus --generate-templates  # should work with IR
```

## Migration Notes

### For Users
- `--generate-templates` flag behavior unchanged (now uses IR internally)
- `-g` short flag preserved
- Template output format improved (better struct expansion, null handling)

### For Developers
- All template logic now in `CLI.Template.hs`
- IR types in `IR.Types` are the source of truth
- SchemaF still used for navigation, may be removed in future

## Verification Checklist

- [ ] `cabal build` succeeds after removal
- [ ] `cabal test` passes
- [ ] `synapse plexus --help` works
- [ ] `synapse plexus --generate-templates` generates templates
- [ ] Templates render correctly for all plugins
- [ ] No runtime errors on cone chat, echo, health check

## Future Considerations

1. **Navigation to IR**: Currently `Algebra.Navigate` works on raw schema. Could be refactored to work on IR for consistency.

2. **SchemaF Removal**: Once navigation moves to IR, the entire `Algebra.*` hierarchy (except maybe Render) could be removed.

3. **Completion from IR**: Shell completions could be reimplemented using IR types for better enum/variant awareness.
